
# Exploiting Expired Tokens for Unauthorized Password Resets

Password reset mechanisms are critical for maintaining the security and usability of web applications. However, if these mechanisms are not implemented securely, they can be exploited by attackers to compromise user accounts. During a bug bounty program, I discovered a vulnerability in a password reset system that allows expired tokens to be manipulated, enabling unauthorized password resets.

---

## Details of the Exploit

Password reset functionality typically relies on temporary tokens to authenticate users attempting to reset their passwords. These tokens are often emailed to the user and designed to expire after a predefined time (e.g., 2 hours). However, in this particular implementation, I identified flaws in the token validation process that undermined the security of the system.

### Key Observations

1. **Initial Token Issuance**:
   - A password reset request generates an email containing a tokenized link.
   - The email states that the token will expire after 2 hours.

2. **Token Manipulation**:
   - Even after the token has expired, altering the last character (e.g., replacing a letter with a number) allows the manipulated token to bypass expiration checks.

3. **Alternative Endpoint**:
   - The system provides an alternative endpoint (e.g., `/change-password?c=`) where the token can be directly submitted. This endpoint does not enforce strict expiration validation.

---

## Steps to Reproduce the Vulnerability

1. **Password Reset Request**:
   - Request a password reset and receive the email with the reset link and token.

2. **Wait for Expiration**:
   - Allow the token to expire by waiting for more than 2 hours.

3. **Token Manipulation**:
   - Retrieve the expired token from the email.
   - Modify the last character of the token. For example:
     - Original Token: `abc123xyz`
     - Manipulated Token: `abc123xy1`

4. **Submit the Manipulated Token**:
   - Navigate to the alternative endpoint (e.g., `/change-password?c=`) and submit the manipulated token.

5. **Observe the Outcome**:
   - The system accepts the manipulated token and allows the password to be reset, bypassing the expiration logic.

---

## Root Cause Analysis

The vulnerability arises due to flaws in the token validation process:

1. **Missing Timestamp Validation**:
   - The token lacks a timestamp or expiry field that is strictly enforced during validation.

2. **Lack of Cryptographic Integrity**:
   - The system does not verify the cryptographic integrity of the token. Tokens are not signed or hashed using secure methods such as HMAC (Hash-based Message Authentication Code) or JWT (JSON Web Token).

3. **Weak Token Parsing Logic**:
   - The endpoint accepts manipulated tokens, indicating that the system does not adequately validate token structure or detect alterations.

---

## Impact of the Vulnerability

The ability to manipulate expired tokens has significant security implications:

1. **Account Takeover**:
   - Attackers can reset passwords for accounts without the user's consent, gaining unauthorized access.

2. **User Trust Erosion**:
   - Exploiting this vulnerability can lead to a loss of trust in the application's security mechanisms.

3. **Increased Risk of Credential Theft**:
   - If exploited in conjunction with other attacks (e.g., phishing), this vulnerability could enable large-scale account compromises.

---

## Suggested Fixes

1. **Implement Timestamp-Based Expiration**:
   - Tokens should include a timestamp or expiration field, which is validated during each password reset request:
     ```javascript
     function isTokenExpired(token) {
         const currentTime = Date.now();
         const tokenTime = parseTokenTimestamp(token);
         return (currentTime - tokenTime) > TOKEN_EXPIRY_LIMIT;
     }
     ```

2. **Use Cryptographically Secure Tokens**:
   - Generate tokens using secure mechanisms like HMAC or JWT, which include a signature to ensure token integrity:
     ```javascript
     const crypto = require('crypto');
     function generateToken(data, secret) {
         return crypto.createHmac('sha256', secret).update(data).digest('hex');
     }
     ```

3. **Validate Token Structure**:
   - Verify that tokens have not been altered by comparing their signature with a server-side hash.

4. **Reject Manipulated Tokens**:
   - Tokens should fail validation if their structure or content does not match the original server-issued format.

5. **Limit Alternative Methods**:
   - Consolidate all password reset processes into a single, secure endpoint to reduce attack surfaces.

---

## Timeline and Resolution

- **Discovery Date:** November 12, 2024  
- **Report Submission:** November 13, 2024  
- **Triaging Completed:** November 14, 2024  
- **Fix Deployed:** November 20, 2024  
- **Acknowledgment:** Received public recognition and a private thank-you note.  

---

This vulnerability highlights the importance of implementing robust security practices for password reset systems. Cryptographic integrity, strict expiration enforcement, and comprehensive validation are essential to protect users from unauthorized account access. By addressing these issues, web applications can significantly enhance their resilience against token manipulation attacks.
